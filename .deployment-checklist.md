# Pre-Deployment Security Verification Checklist

Complete this checklist before deploying to production to ensure all security measures are in place.

## Environment & Configuration
- [ ] All environment variables validated at startup (check `env-validator.js`)
- [ ] `.env` files NOT committed to git (verify `.gitignore` includes `.env*`)
- [ ] `SESSION_SECRET` is cryptographically random (minimum 32 characters)
- [ ] `NODE_ENV=production` set in production environment
- [ ] Database connection uses SSL/TLS in production
- [ ] Redis connection uses password authentication
- [ ] All API URLs use HTTPS in production (no HTTP)

## Security Headers & CORS
- [ ] CORS configured with specific origin (not `*`)
- [ ] `credentials: true` enabled for session cookies
- [ ] httpOnly cookies enabled for session ID
- [ ] Secure flag enabled on cookies (HTTPS only in production)
- [ ] CSRF protection via state parameter validated in OAuth callback
- [ ] SameSite cookie attribute set to 'strict' in production

## Authentication & Authorization
- [ ] Complete PKCE flow implemented (code_verifier + code_challenge)
- [ ] State parameter validated on OAuth callback
- [ ] Tokens stored in Redis (NEVER in frontend/localStorage)
- [ ] Session expiration configured (24 hours default)
- [ ] Token refresh logic tested and working
- [ ] Logout properly destroys session and clears cookies

## Rate Limiting & Monitoring
- [ ] Express rate limiter active (100 requests/15min per IP)
- [ ] Spotify API rate limiter active (30 requests/min)
- [ ] Auth rate limiter active (20 requests/15min)
- [ ] Winston logger configured with file rotation
- [ ] Error logs monitored (set up alerts for production)
- [ ] Migration history tracked in database

## Database & Infrastructure
- [ ] PostgreSQL schema migrations applied successfully
- [ ] Database backups configured and tested
- [ ] Redis persistence enabled (AOF or RDB)
- [ ] Connection pools configured with appropriate limits
- [ ] Database indexes created for performance
- [ ] Test database connection before server starts

## Testing & Validation
- [ ] All Jest tests passing (`npm test`)
- [ ] OAuth flow tested with real Spotify accounts
- [ ] Migration tested with 100+ songs
- [ ] Migration tested with 1000+ songs
- [ ] Rate limit handling verified (429 responses)
- [ ] Error responses follow standard format
- [ ] Token refresh tested when tokens expire
- [ ] Deduplication logic verified

## Production Readiness
- [ ] Frontend build optimized (`npm run build`)
- [ ] No `console.log` in production code (or wrapped in NODE_ENV check)
- [ ] Sensitive data redacted from logs (tokens, passwords)
- [ ] Health check endpoint available (`/health`)
- [ ] README documentation complete and accurate
- [ ] Error messages are user-friendly (no stack traces in production)

## Spotify App Configuration
- [ ] Spotify Developer app created
- [ ] Client ID and Client Secret obtained
- [ ] Redirect URIs configured correctly:
  - Development: `http://localhost:5173/callback`
  - Production: `https://yourdomain.com/callback`
- [ ] Required scopes enabled:
  - `user-library-read`
  - `user-library-modify`
  - `user-read-email`

## Infrastructure Setup
- [ ] PostgreSQL database provisioned and accessible
- [ ] Redis server provisioned and accessible
- [ ] Server has sufficient resources (min 512MB RAM)
- [ ] SSL/TLS certificates configured for HTTPS
- [ ] Domain name configured and DNS propagated
- [ ] Firewall rules configured (allow ports 80, 443)

## Deployment Steps
- [ ] Environment variables set in production environment
- [ ] Database schema applied to production database
- [ ] Dependencies installed (`npm install` in both server and client)
- [ ] Frontend built (`npm run build` in client)
- [ ] Backend server started with process manager (PM2, systemd)
- [ ] Health check endpoint returns 200 OK
- [ ] Test OAuth flow in production
- [ ] Test migration with small dataset first

## Post-Deployment Monitoring
- [ ] Monitor error logs for first 24 hours
- [ ] Check database connection pool usage
- [ ] Monitor Redis memory usage
- [ ] Verify rate limiting is working
- [ ] Check migration success rates
- [ ] Monitor API response times

## Emergency Rollback Plan
- [ ] Previous version tagged in git
- [ ] Database backup created before deployment
- [ ] Rollback procedure documented
- [ ] Team knows how to execute rollback

---

## Quick Start Commands

### Development
```bash
# Backend
cd server
npm install
npm run dev

# Frontend
cd client
npm install
npm run dev
```

### Production Build
```bash
# Frontend
cd client
npm run build

# Backend (with PM2)
cd server
pm2 start index.js --name spotify-migration
pm2 save
```

### Database Setup
```bash
# Create database
psql -U postgres
CREATE DATABASE spotify_migration;

# Apply schema
psql -U postgres -d spotify_migration -f server/database/schema.sql
```

---

**Last Updated:** 2025-12-16
**Version:** 1.0.0
